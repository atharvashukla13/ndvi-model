<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AgriSmart - Official Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.2em;
        opacity: 0.9;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      .card:hover {
        transform: translateY(-5px);
      }

      .card h3 {
        color: #4a5568;
        margin-bottom: 15px;
        font-size: 1.3em;
      }

      .stat-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }

      .stat-item {
        text-align: center;
        padding: 15px;
        background: #f7fafc;
        border-radius: 10px;
      }

      .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: #2d3748;
      }

      .stat-label {
        color: #718096;
        font-size: 0.9em;
        margin-top: 5px;
      }

      .alert {
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 10px;
        border-left: 4px solid;
      }

      .alert.high {
        background: #fed7d7;
        border-color: #e53e3e;
        color: #742a2a;
      }

      .alert.medium {
        background: #fef5e7;
        border-color: #dd6b20;
        color: #7b341e;
      }

      .alert.low {
        background: #c6f6d5;
        border-color: #38a169;
        color: #22543d;
      }

      .chart-container {
        height: 400px;
        margin-top: 20px;
      }

      .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1em;
        transition: all 0.3s ease;
        margin: 5px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #718096;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-online {
        background: #38a169;
      }

      .status-offline {
        background: #e53e3e;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üå± AgriSmart Dashboard</h1>
        <p>AI-Powered Agricultural Monitoring System</p>
      </div>

      <div class="dashboard-grid">
        <!-- System Status -->
        <div class="card">
          <h3>System Status</h3>
          <div id="system-status">
            <div class="loading">Loading system status...</div>
          </div>
        </div>

        <!-- Regional Statistics -->
        <div class="card">
          <h3>Regional Statistics</h3>
          <div id="regional-stats">
            <div class="loading">Loading regional data...</div>
          </div>
        </div>

        <!-- Alerts -->
        <div class="card">
          <h3>Priority Alerts</h3>
          <div id="alerts">
            <div class="loading">Loading alerts...</div>
          </div>
        </div>

        <!-- Fertility Zones -->
        <div class="card">
          <h3>Fertility Zones Distribution</h3>
          <div id="fertility-chart" class="chart-container"></div>
        </div>

        <!-- Growth Stages -->
        <div class="card">
          <h3>Growth Stages Distribution</h3>
          <div id="growth-chart" class="chart-container"></div>
        </div>

        <!-- Actions -->
        <div class="card">
          <h3>Quick Actions</h3>
          <button class="btn" onclick="refreshData()">üîÑ Refresh Data</button>
          <button class="btn" onclick="downloadReport()">
            üìä Download Report
          </button>
          <button class="btn" onclick="viewMap()">üó∫Ô∏è View Regional Map</button>
          <button class="btn" onclick="exportData()">üì§ Export Data</button>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let dashboardData = null;

      // Initialize dashboard
      document.addEventListener("DOMContentLoaded", function () {
        loadDashboardData();
        setInterval(loadDashboardData, 30000); // Refresh every 30 seconds
      });

      // Load dashboard data
      async function loadDashboardData() {
        try {
          // Load system status
          const statusResponse = await fetch("/api/health");
          const statusData = await statusResponse.json();
          updateSystemStatus(statusData);

          // Load official dashboard data
          const dashboardResponse = await fetch("/api/official_dashboard");
          const dashboardData = await dashboardResponse.json();
          updateDashboard(dashboardData.dashboard);
        } catch (error) {
          console.error("Error loading dashboard data:", error);
          showError("Failed to load dashboard data");
        }
      }

      // Update system status
      function updateSystemStatus(data) {
        const statusDiv = document.getElementById("system-status");
        const models = data.models_loaded;

        statusDiv.innerHTML = `
                <div class="stat-item">
                    <div class="status-indicator ${
                      data.status === "healthy"
                        ? "status-online"
                        : "status-offline"
                    }"></div>
                    <div class="stat-value">${data.status.toUpperCase()}</div>
                    <div class="stat-label">System Status</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${models.cnn ? "‚úì" : "‚úó"}</div>
                    <div class="stat-label">CNN Model</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${
                      models.random_forest ? "‚úì" : "‚úó"
                    }</div>
                    <div class="stat-label">Random Forest</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${models.pipeline ? "‚úì" : "‚úó"}</div>
                    <div class="stat-label">Pipeline</div>
                </div>
            `;
      }

      // Update dashboard with data
      function updateDashboard(data) {
        dashboardData = data;

        // Update regional statistics
        updateRegionalStats(data.regional_stats);

        // Update alerts
        updateAlerts(data.alerts);

        // Update charts
        updateFertilityChart(data.regional_map.fertility_zones);
        updateGrowthChart(data.regional_map.growth_stages);
      }

      // Update regional statistics
      function updateRegionalStats(stats) {
        const statsDiv = document.getElementById("regional-stats");
        statsDiv.innerHTML = `
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-value">${stats.total_farmers.toLocaleString()}</div>
                        <div class="stat-label">Total Farmers</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.active_fields.toLocaleString()}</div>
                        <div class="stat-label">Active Fields</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${
                          stats.avg_yield_improvement
                        }</div>
                        <div class="stat-label">Avg Yield Improvement</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${
                          stats.total_area_monitored
                        }</div>
                        <div class="stat-label">Area Monitored</div>
                    </div>
                </div>
            `;
      }

      // Update alerts
      function updateAlerts(alerts) {
        const alertsDiv = document.getElementById("alerts");
        if (alerts.length === 0) {
          alertsDiv.innerHTML = '<div class="alert low">No active alerts</div>';
          return;
        }

        alertsDiv.innerHTML = alerts
          .map(
            (alert) => `
                <div class="alert ${alert.type.replace("_priority", "")}">
                    <strong>${alert.message}</strong><br>
                    <small>Count: ${alert.count} | ${new Date(
              alert.timestamp
            ).toLocaleString()}</small>
                </div>
            `
          )
          .join("");
      }

      // Update fertility chart
      function updateFertilityChart(fertilityData) {
        const data = [
          {
            values: [
              fertilityData.high,
              fertilityData.medium,
              fertilityData.low,
            ],
            labels: ["High Fertility", "Medium Fertility", "Low Fertility"],
            type: "pie",
            marker: {
              colors: ["#38a169", "#dd6b20", "#e53e3e"],
            },
          },
        ];

        const layout = {
          title: "Fertility Zones Distribution",
          font: { size: 12 },
        };

        Plotly.newPlot("fertility-chart", data, layout, { responsive: true });
      }

      // Update growth stages chart
      function updateGrowthChart(growthData) {
        const data = [
          {
            values: [growthData.early, growthData.mid, growthData.late],
            labels: ["Early Stage", "Mid Stage", "Late Stage"],
            type: "pie",
            marker: {
              colors: ["#fbb6ce", "#90cdf4", "#68d391"],
            },
          },
        ];

        const layout = {
          title: "Growth Stages Distribution",
          font: { size: 12 },
        };

        Plotly.newPlot("growth-chart", data, layout, { responsive: true });
      }

      // Action functions
      function refreshData() {
        loadDashboardData();
      }

      function downloadReport() {
        window.open("/api/download_report?type=official_dashboard", "_blank");
      }

      function viewMap() {
        alert("Regional map view would open here");
      }

      function exportData() {
        if (dashboardData) {
          const dataStr = JSON.stringify(dashboardData, null, 2);
          const dataBlob = new Blob([dataStr], { type: "application/json" });
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement("a");
          link.href = url;
          link.download = "agrismart_dashboard_data.json";
          link.click();
        }
      }

      function showError(message) {
        console.error(message);
        // You could add a toast notification here
      }
    </script>
  </body>
</html>
